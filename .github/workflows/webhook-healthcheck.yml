name: Ops Webhook Healthcheck

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Send signed health pings to ops-api
        env:
          OPS_URL: https://ops.engel2ink.com/webhooks/health
          OPS_WEBHOOK_SECRET: ${{ secrets.OPS_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail

          send() {
            local SITE="$1"
            local TS BODY SIG HTTP

            TS="$(date +%s)"
            BODY="{\"source\":\"github\",\"event\":\"healthcheck\",\"site\":\"${SITE}\",\"state\":\"UP\",\"checked_at\":\"$(date -u +%FT%TZ)\"}"
            SIG="$(printf "%s" "$TS.$BODY" | openssl dgst -sha256 -hmac "$OPS_WEBHOOK_SECRET" -hex | awk '{print $2}')"

            HTTP="$(curl -sS -o /tmp/resp.json -w "%{http_code}" -X POST "$OPS_URL" \
              -H "content-type: application/json" \
              -H "x-ops-timestamp: $TS" \
              -H "x-ops-signature: $SIG" \
              --data "$BODY")"

            cat /tmp/resp.json
            echo "HTTP=$HTTP"
            test "$HTTP" = "200"
          }

          send everydayengel
          send engel2ink
